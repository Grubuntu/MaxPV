<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <meta name="description" content="">
    <meta name="author" content="Bernard Legrand">
    <title>MaxPv! Configuration</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="maxpv.css" rel="stylesheet">
  </head>

  <body onload= "fillParam ( )">
   

<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">MaxPV!</a>
    <span class="badge rounded-pill text-bg-warning" id="ecopvstate">Routeur</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav me-auto mb-2 mb-md-0">
        <li class="nav-item">
          <a class="nav-link" href="/">Moniteur</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Graphiques</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="configuration.html">Configuration</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Wizard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="update">Update</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="credits.html">Credits</a>
        </li>
      </ul>
    </div>
  </div>
</nav>



<main class="container">
  <div class="bg-light p-5 rounded">
    <h1>Configuration</h1>
    <p class="lead"><h4>Paramètres du routeur</h4>
    <span class="text-danger">N'oubliez pas de sauvegarder les paramètres et de redémarrer le routeur !</span></p>    

    <table class="table text-center align-middle">
          <thead>
            <tr class="table-primary">
              <th colspan="3">Installation</th>
            </tr>
          </thead>
          <tr>
            <th scope="row">P_INSTALLPV</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_installpv"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_installpv', this)">Envoyer</button></td>
          </tr>
            <tr>
            <th scope="row">P_RESISTANCE</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_resistance"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_resistance', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">CNT_CALIB</th>
            <td scope="col"><input type="text" class="form-control text-center" id="cnt_calib"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('cnt_calib', this)">Envoyer</button></td>
          </tr>
          <thead>
            <tr class="table-primary">
              <th colspan="3">Calibrage</th>
            </tr>
          </thead>
          <tr>
            <th scope="row">V_CALIB</th>
            <td scope="col"><input type="text" class="form-control text-center" id="v_calib"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('v_calib', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">P_CALIB</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_calib"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_calib', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">PHASE_CALIB</th>
            <td scope="col"><input type="text" class="form-control text-center" id="phase_calib"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('phase_calib', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">P_OFFSET</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_offset"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_offset', this)">Envoyer</button></td>
          </tr>
          <thead>
            <tr class="table-primary">
              <th colspan="3">Régulation</th>
            </tr>
          </thead>
          <tr>
            <th scope="row">P_MARGIN</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_margin"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_margin', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">GAIN_P</th>
            <td scope="col"><input type="text" class="form-control text-center" id="gain_p"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('gain_p', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">GAIN_I</th>
            <td scope="col"><input type="text" class="form-control text-center" id="gain_i"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('gain_i', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">E_RESERVE</th>
            <td scope="col"><input type="text" class="form-control text-center" id="e_reserve"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('e_reserve', this)">Envoyer</button></td>
          </tr>
          <thead>
            <tr class="table-primary">
              <th colspan="3">Relais secondaire</th>
            </tr>
          </thead>
          <tr>
            <th scope="row">P_DIV2_ACTIVE</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_div2_active"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_div2_active', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">P_DIV2_IDLE</th>
            <td scope="col"><input type="text" class="form-control text-center" id="p_div2_idle"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('p_div2_idle', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">T_DIV2_ON</th>
            <td scope="col"><input type="text" class="form-control text-center" id="t_div2_on"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('t_div2_on', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">T_DIV2_OFF</th>
            <td scope="col"><input type="text" class="form-control text-center" id="t_div2_off"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('t_div2_off', this)">Envoyer</button></td>
          </tr>
          <tr>
            <th scope="row">T_DIV2_TC</th>
            <td scope="col"><input type="text" class="form-control text-center" id="t_div2_tc"></td>
            <td scope="col"><button class="btn btn-primary" type="submit" onclick="sendParam ('t_div2_tc', this)">Envoyer</button></td>
          </tr>
        </tbody>
    </table>
  


    <div class="d-grid gap-2">
        <button class="btn btn-warning" type="submit" onclick="sendAction ( 'saveparam', this )">Sauver des paramètres dans l'EEPROM</button>
        <button class="btn btn-warning" type="submit" onclick="sendAction ( 'loadparam', this )">Charger les paramètres de l'EEPROM</button>
        <button class="btn btn-warning" type="submit" onclick="sendAction ( 'saveindex', this  )">Sauver les index</button>
        <button class="btn btn-warning" type="submit" onclick="sendAction ( 'restart', this  )">Redémarrer le routeur</button>
        <button class="btn btn-danger"  type="submit" onclick="sendAction ( 'resetindex', this  )">Remettre à zéro les index</button>
        <button class="btn btn-danger"  type="submit" onclick="sendAction ( 'format', this  )">Formater l'EEPROM</button>
        <button class="btn btn-dark"    type="submit" onclick="sendAction ( 'rebootesp', this  )">Redémarrer le Webserver</button>
    </div>

  </div>   
</main>



<script>
	<!-- récupération des données sur le serveur -->

    const nb_param = 16;
    const paramList = [ "FAKE", "v_calib", "p_calib", "phase_calib", "p_offset",
                        "p_resistance", "p_margin", "gain_p", "gain_i",
                        "e_reserve", "p_div2_active", "p_div2_idle", "t_div2_on",
                        "t_div2_off", "t_div2_tc", "cnt_calib", "p_installpv" ];

    function sendAction ( action, ele ) {
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "api/action?" + action, true);
        xhttp.send ( );
        ele.blur ( );
        fillParam ( );
    }  

    function sendParam ( param, ele ) {
        var xhttp = new XMLHttpRequest();
        var args = "api/set?param=";
        var num_param = paramList.indexOf ( param );
        var value_param = document.getElementById ( param ).value;
        args += num_param;
        args += "&value=";
        args += value_param;   
        xhttp.open("GET", args, true);
        xhttp.send();
        ele.blur ( );
        //location.reload();
        //document.getElementById ( param ).placeholder = value_param;
        //document.getElementById ( param ).value = value_param;
    }  

    function fillParam ( ) {
        var xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function ( ) {
            if ( this.readyState == 4 && this.status == 200 ) {
                var config = this.responseText.split(",");
                for (let pas = 0; pas < nb_param; pas++) {   
                    //document.getElementById ( paramList[pas + 1] ).placeholder = config[pas];
                    document.getElementById ( paramList[pas + 1] ).value = config[pas];
                }
            }
        };
        xhttp1.open("GET", "api/get?allparam", true);
        xhttp1.send();
    }


  setInterval ( function ( ) {
    var xhttp5 = new XMLHttpRequest();
    
    xhttp5.onreadystatechange = function ( ) {
      if ( this.readyState == 4 && this.status == 200 ) {
        var result = this.responseText;    
        if ( result == "running" ) {
          document.getElementById("ecopvstate").innerHTML = "Routeur running";
          document.getElementById("ecopvstate").className = "badge rounded-pill text-bg-success";
        }
        else {
          document.getElementById("ecopvstate").innerHTML = "Routeur offline";
          document.getElementById("ecopvstate").className = "badge rounded-pill text-bg-warning";
        }
      }
    };
    xhttp5.open("GET", "api/get?ping", true);
    xhttp5.send();

    }, 1000 ) ;	


</script>      


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

      
</body>
</html>
